--급여관리 2022-05-11
DROP TABLE EMPLOYEE_TBL_13;
DROP TABLE WORK_TBL_13;

CREATE TABLE EMPLOYEE_TBL_13(
EMPLOYEE_NO NUMBER NOT NULL PRIMARY KEY,
EMPLOYEE_NAME VARCHAR2(20) NOT NULL,
DEPT_NO CHAR(2),
HIRE_DATE DATE,
EMPLOYEE_STATUS CHAR(1)
);

INSERT INTO EMPLOYEE_TBL_13 VALUES(1001,'김을동','10','18/02/10','1');
INSERT INTO EMPLOYEE_TBL_13 VALUES(1002,'박기동','10','18/02/10','2');
INSERT INTO EMPLOYEE_TBL_13 VALUES(1003,'최순자','20','18/02/11','1');
INSERT INTO EMPLOYEE_TBL_13 VALUES(1004,'강하나','20','18/02/11','1');
INSERT INTO EMPLOYEE_TBL_13 VALUES(1005,'채시라','30','18/02/10','1');

CREATE TABLE WORK_TBL_13(
WORK_DATE CHAR(8) NOT NULL,
EMPLOYEE_NO NUMBER NOT NULL,
WORK_IN_TIME VARCHAR(4),
WORK_OUT_TIME VARCHAR(4),
PRIMARY KEY(WORK_DATE, EMPLOYEE_NO)
);

--문제-1 : 1001 아침출근 저녁퇴근
INSERT INTO WORK_TBL_13 VALUES('20180901',1001,'0910','1510');
INSERT INTO WORK_TBL_13 VALUES('20180902',1001,'0910','1510');
INSERT INTO WORK_TBL_13 VALUES('20180903',1001,'0910','1520');
INSERT INTO WORK_TBL_13 VALUES('20180904',1001,'0810','1610');
INSERT INTO WORK_TBL_13 VALUES('20180907',1001,'0910','1630');
INSERT INTO WORK_TBL_13 VALUES('20180908',1001,'0900','1500');
INSERT INTO WORK_TBL_13 VALUES('20180909',1001,'0930','1500');
INSERT INTO WORK_TBL_13 VALUES('20180911',1001,'0920','1540');
INSERT INTO WORK_TBL_13 VALUES('20180912',1001,'0900','1500');

--문제-2 : 1001 저녁출근 새벽퇴근
INSERT INTO WORK_TBL_13 VALUES('20180901',1001,'1910','0510');
INSERT INTO WORK_TBL_13 VALUES('20180902',1001,'1910','0510');
INSERT INTO WORK_TBL_13 VALUES('20180903',1001,'1910','0520');
INSERT INTO WORK_TBL_13 VALUES('20180904',1001,'1810','0610');
INSERT INTO WORK_TBL_13 VALUES('20180907',1001,'1910','0630');
INSERT INTO WORK_TBL_13 VALUES('20180908',1001,'1900','0500');
INSERT INTO WORK_TBL_13 VALUES('20180909',1001,'1930','0500');
INSERT INTO WORK_TBL_13 VALUES('20180911',1001,'1920','0540');
INSERT INTO WORK_TBL_13 VALUES('20180912',1001,'1900','0500');

--1003
INSERT INTO WORK_TBL_13 VALUES('20180911',1003,'1210','1710');
INSERT INTO WORK_TBL_13 VALUES('20180912',1003,'1210','1710');
INSERT INTO WORK_TBL_13 VALUES('20180913',1003,'1210','1720');
INSERT INTO WORK_TBL_13 VALUES('20180914',1003,'1210','1710');
INSERT INTO WORK_TBL_13 VALUES('20180915',1003,'1210','1730');
INSERT INTO WORK_TBL_13 VALUES('20180916',1003,'1200','1700');
INSERT INTO WORK_TBL_13 VALUES('20180917',1003,'1230','1700');
INSERT INTO WORK_TBL_13 VALUES('20180918',1003,'1220','1740');

SELECT* FROM EMPLOYEE_TBL_13;
SELECT* FROM WORK_TBL_13;

select nvl(max(EMPLOYEE_NO),0)+1 as EMPLOYEE_NO
from EMPLOYEE_TBL_13;

--select.jsp-------------------------------------------
select EMPLOYEE_NO, EMPLOYEE_NAME, DEPT_NO, 
to_char(HIRE_DATE,'yyyy-mm-dd') as HIRE_DATE, EMPLOYEE_STATUS,
decode(EMPLOYEE_STATUS,'1','입사','2','퇴사','3','휴직')
from EMPLOYEE_TBL_13
order by EMPLOYEE_NO;

--https://devjhs.tistory.com/110 참조
--select2_1.jsp(방법-1) : 급여조회(1001:아침출근-저녁퇴근,저녁출근-새벽퇴근) 시간당 9000원을 받는다면 1분당 "9000/60=150원"을 받음
--순서-1
--to_date():'문자->날짜' 데이터 타입으로 변환(이유?날짜로 연산하기 위해. ★★결과가 '일'단위)
select substr(WORK_DATE,1,6) as WORK_DATE, EMPLOYEE_NO,
to_date(WORK_IN_TIME,'hh24mi') WORK_IN_TIME,

(case --저녁출근-새벽퇴근
when WORK_IN_TIME>WORK_OUT_TIME THEN (to_date(WORK_OUT_TIME,'hh24mi')+1)--+1의미:하루 추가
--아침출근-저녁퇴근
else to_date(WORK_OUT_TIME,'hh24mi')
end) as WORK_OUT_TIME


from WORK_TBL_13;


--순서-2
select substr(WORK_DATE,1,6), EMPLOYEE_NO,
SUM( round((WORK_OUT_TIME-WORK_IN_TIME)*24*60,2)) *(9000/60)  as salary
--SUM( round((WORK_OUT_TIME-WORK_IN_TIME)*24*60,2) *(9000/60)) as salary
from(select substr(WORK_DATE,1,6) as WORK_DATE, EMPLOYEE_NO,
	to_date(WORK_IN_TIME,'hh24mi') WORK_IN_TIME,
	
	(case --저녁출근-새벽퇴근
	when WORK_IN_TIME>WORK_OUT_TIME THEN (to_date(WORK_OUT_TIME,'hh24mi')+1)--+1의미:하루 추가
	--아침출근-저녁퇴근
	else to_date(WORK_OUT_TIME,'hh24mi')
	end) as WORK_OUT_TIME
	
	
	from WORK_TBL_13) NATURAL JOIN EMPLOYEE_TBL_13 --NATURAL JOIN 이유?퇴사 사원 제외

group by substr(WORK_DATE,1,6), EMPLOYEE_NO;
--아침출근-저녁퇴근 :결과 363000  516000
--저녁출근-새벽퇴근 :결과 363000  840000

--select2_2.jsp(방법-2)----------------------------------------------------
--순서-1 : 일한 시간을 분으로 구함
select EMPLOYEE_NO,

(case
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2)) > 0--아침출근-저녁퇴근
then (SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2))*60 + SUM(substr(WORK_OUT_TIME,3,2)-substr(WORK_IN_TIME,3,2)))
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2)) < 0--저녁출근-새벽퇴근
then (SUM(24 + substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2))*60 + SUM(substr(WORK_OUT_TIME,3,2)-substr(WORK_IN_TIME,3,2)))
end) as total_mi

from WORK_TBL_13
GROUP BY EMPLOYEE_NO;

--순서-2 : 일한 시간을 분으로 구함*(9000원/60분)
select substr(WORK_DATE,1,6), EMPLOYEE_NO,

(case
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2)) > 0--아침출근-저녁퇴근
then (SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2))*60 + SUM(substr(WORK_OUT_TIME,3,2)-substr(WORK_IN_TIME,3,2))) * (9000/60)
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2)) < 0--저녁출근-새벽퇴근
then (SUM(24 + substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2))*60 + SUM(substr(WORK_OUT_TIME,3,2)-substr(WORK_IN_TIME,3,2))) * (9000/60)
end) as salary

from WORK_TBL_13 NATURAL JOIN EMPLOYEE_TBL_13  --NATURAL JOIN 이유?퇴사 사원 제외위해
GROUP BY substr(WORK_DATE,1,6), EMPLOYEE_NO;



--select2_3.jsp(방법-3)----------------------------------------------------
--아침 출근-저녁 퇴근
--순서-1 
SELECT EMPLOYEE_NO, 
TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS') as WORK_IN_TIME,
TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS')  as WORK_OUT_TIME
FROM WORK_TBL_13;

--순서-2
SELECT EMPLOYEE_NO, 
TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS') as WORK_IN_TIME,
TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS') as WORK_OUT_TIME,
TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS') as WORK_OUT_IN_TIME
FROM WORK_TBL_13;

--순서-3
SELECT substr(WORK_DATE,1,6), EMPLOYEE_NO, 
round(SUM(TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS'))*24*60 *(9000/60),0) as salary
FROM WORK_TBL_13
GROUP BY substr(WORK_DATE,1,6), EMPLOYEE_NO;

--저녁출근-새벽퇴근
--순서-3
SELECT substr(WORK_DATE,1,6), EMPLOYEE_NO, 
round(SUM(1+TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS'))*24*60 *(9000/60),0) as salary
FROM WORK_TBL_13
GROUP BY substr(WORK_DATE,1,6), EMPLOYEE_NO;

--select2_3.jsp 최종
SELECT substr(WORK_DATE,1,6), EMPLOYEE_NO,
(case
--아침출근-저녁퇴근
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2)) > 0
then round(SUM(TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS'))*24*60 *(9000/60),0)
--저녁출근-아침퇴근
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2)) < 0
then round(SUM(1+TO_DATE(WORK_DATE||' '||WORK_OUT_TIME, 'YYYYMMDD HH24:MI:SS')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME, 'YYYYMMDD HH24:MI:SS'))*24*60 *(9000/60),0)
end) as salary
FROM WORK_TBL_13 NATURAL JOIN EMPLOYEE_TBL_13  --NATURAL JOIN 이유?퇴사 사원 제외
GROUP BY substr(WORK_DATE,1,6), EMPLOYEE_NO;


----------------------------------------------------------------------------------------------------
--select2_4.jsp(방법-4 - 급여조회(1001:저녁출근-새벽퇴근)):1분 당 150원(시간당 9000원 받는다면 9000/60=150) -------------------------
--https://offbyone.tistory.com/233
--분단위의 차이를 구하기 위해서는 다음과 같이 계산 합니다. 
--역시 초단위가 있으면 소숫점 값이 나오므로 단순하게 하기 위해서 초단위는 잘라버리고 계산 합니다.
--날짜의 초단위를 자르기 위해서 TRUNC 함수가 사용되었습니다. TRUNC(SYSDATE, 'MI') 를 사용해서 초단위를 자릅니다. 
--값을 분으로 변환하기 위해서 1440을 곱해주었습니다. 이 값은 24 * 60 해서 나온 값입니다.
--순서-1 : 아침 출근-저녁 퇴근
SELECT EMPLOYEE_NO, 
-SUM(
	(
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_OUT_TIME,'YYYYMMDD HH24:MI:SS'))
	-
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME,'YYYYMMDD HH24:MI:SS'))
	)*24*60
) * (9000/60) AS salary
FROM WORK_TBL_13
GROUP BY EMPLOYEE_NO;

--순서-2 : 저녁 출근-새벽 퇴근
SELECT EMPLOYEE_NO, 
SUM( 
	(1 +
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_OUT_TIME,'YYYYMMDD HH24:MI:SS'))
	-
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME,'YYYYMMDD HH24:MI:SS'))
	)*24*60
) * (9000/60) AS salary
FROM WORK_TBL_13
GROUP BY EMPLOYEE_NO;

--순서-3
SELECT substr(WORK_DATE,1,6), EMPLOYEE_NO,
(case
when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2))>0 --아침출근-저녁퇴근
then -SUM(
	(
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_OUT_TIME,'YYYYMMDD HH24:MI:SS'))
	-
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME,'YYYYMMDD HH24:MI:SS'))
	)*24*60
) * (9000/60)

when SUM(substr(WORK_OUT_TIME,1,2)-substr(WORK_IN_TIME,1,2))<0 --저녁퇴근-아침출근
then SUM( 
	(1 -
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_OUT_TIME,'YYYYMMDD HH24:MI:SS'))
	+
	(TRUNC(SYSDATE, 'MI')-TO_DATE(WORK_DATE||' '||WORK_IN_TIME,'YYYYMMDD HH24:MI:SS'))
	)*24*60
) * (9000/60)
end
) AS salary
FROM WORK_TBL_13 NATURAL JOIN EMPLOYEE_TBL_13  --NATURAL JOIN 이유?퇴사한 사람 제외위해
GROUP BY substr(WORK_DATE,1,6), EMPLOYEE_NO;






